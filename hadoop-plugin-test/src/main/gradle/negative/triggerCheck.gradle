buildscript {
  repositories {
    jcenter()
  }
  dependencies {
    classpath files("${project.pluginTestDir}/hadoop-plugin-${project.version}.jar", "${project.pluginTestDir}/hadoop-plugin-${project.version}-SNAPSHOT.jar")
    // Must manually specify snakeyaml for testing, not required for users
    classpath 'org.yaml:snakeyaml:1.18'
    classpath 'org.quartz-scheduler:quartz:2.2.1'
  }
}

apply plugin: com.linkedin.gradle.hadoop.HadoopPlugin

// Simple flow for testing trigger creation

// TODO reallocf negative cases for Cheng's negative cases in AZ

hadoop {
  buildPath "jobs/triggerFlow"
  cleanPath false

  generateYamlOutput true

  workflow('triggerFail1') {
    trigger('trigger1') {
      // no maxWaitMins throws an ERROR
      // no schedule throws an ERROR
      daliDatasetDependency('dali-data-dep') {
        // no dali dataset dependency view throws an ERROR
        // no dali dataset dependency window throws an ERROR
        // no dali dataset dependency delay throws an ERROR
        // no dali dataset dependency unit throws an ERROR
      }
    }

    trigger('trigger2') { // two defined triggers throws an ERROR
      maxWaitMins 0 // maxWaitMins less than 1 throws an ERROR
      schedule('schedule1') {
        // no schedule value throws an ERROR
      }
      schedule('schedule2') { // two schedules throws an ERROR
        value 'abcd' // invalid cron expression for value in schedule throws an ERROR
      }
    }

    commandJob('shellBash') {
      uses 'bash ./sample_script.sh'
    }

    targets 'shellBash'
  }

/**
 * The TriggerChecker rule checks the following:
 * <ul>
 *   <li>Trigger specific
 *   <li>WARN if a trigger maxWaitMins is greater than 10 days (14400) - will be set to 10 days
 *       by Azkaban.</li>
 *   <li>ERROR if a trigger schedule value has an interval smaller than 1 minute.</li>
 *   <li>ERROR if a trigger dependency name is not unique.</li>
 *   <li>ERROR if a trigger dependency config (type + params) is not unique.</li>
 *   <li>
 *   <li>DaliDatasetDependency specific
 *   <li>ERROR if a trigger dali dataset dependency window less than one.</li>
 *   <li>ERROR if a trigger dali dataset dependency delay less than zero.</li>
 *   <li>ERROR if a trigger dali dataset dependency unit is not 'daily' or 'hourly'.</li>
 *   <li>ERROR if a trigger dali dataset dependency ignoreLocation is not 'true' or 'false'.</li>
 * </ul>
 */
  workflow('triggerFail2') {
    trigger('trigger3') {
      maxWaitMins 9999999 // really high maxWaitMins throws a WARN
      schedule('schedule1') {
        value '*/30 0 1 ? * *'// really small cron interval throws an ERROR
      }
      daliDatasetDependency('dali-data-dep') {
        view 'test'
        window 0 // dali dataset dependency window less than 1 throws an ERROR
        delay '-1' as int // dali dataset dependency delay less than 0 throws an ERROR
        unit 'fail' // dali dataset dependency unit not 'daily' or 'hourly' throws an ERROR
        ignoreLocation 'untrue'// dali dataset dependency ignoreLocation not 'true' or 'false'
                               // throws an ERROR
      }
      daliDatasetDependency('dali-data-dep') { // two dependencies with same name throws an ERROR
        view 'test'
        window 1
        delay 0
        unit 'daily'
      }
      daliDatasetDependency('dali-data-dep2') { // two dependencies with same config throws an ERROR
        view 'test'
        window 1
        delay 0
        unit 'daily'
      }
    }

    commandJob('shellPwd') {
      uses 'pwd'
    }

    targets 'shellPwd'
  }
}